<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
<script>
function registerServiceWorker() {
    return navigator.serviceWorker.register('assets/service-worker.js');
}

function askPermission() {
    return new Promise(function(resolve, reject) {
        const permissionResult = Notification.requestPermission(function(result) {
            resolve(result);
        });
        if (permissionResult) {
            permissionResult.then(resolve, reject);
        }
    })
            .then(function(permissionResult) {
                if (permissionResult !== 'granted') {
                    throw new Error('We weren\'t granted permission.');
                }
            });
}

function getNotificationPermissionState() {
    if (navigator.permissions) {
        return navigator.permissions.query({name: 'notifications'})
                .then(function(result) {
                    return result.state;
                });
    }
    return new Promise(function(resolve) {
        resolve(Notification.permission);
    });
}

function subscribeUserToPush(serviceWorkerRegistration) {
    const subscribeOptions = {
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(
                'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U'
        )
    };
    return serviceWorkerRegistration.pushManager.subscribe(subscribeOptions)
            .then(function(pushSubscription) {
                console.log('Received PushSubscription: ', JSON.stringify(pushSubscription));
                return pushSubscription;
            });
}

getNotificationPermissionState()
        .then(function(permissionState) {
            if (permissionState === 'denied') {
                throw new Error('We weren\'t granted permission.');
            } else if (permissionState === 'granted') {
                return registerServiceWorker;
            } else {
                return askPermission()
                        .then(registerServiceWorker);
            }
        })
        .then(subscribeUserToPush);
</script>
</body>
</html>